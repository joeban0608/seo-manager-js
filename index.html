<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <div id="category-buttons"></div>
    <!--  用來顯示文章分類按鈕  -->
    <div id="blog-posts"></div>
    <!--  用來顯示文章列表  -->
    <div id="pagination"></div>
    <!--  用來顯示分頁按鈕  -->
    <style>
      body {
        width: 100dvw;
        height: 100dvh;
      }
      /* 使用 Masonry Layout 實現瀑布流布局 */
      #blog-posts {
        column-count: 3;
        column-gap: 20px; /* 調整列間距 */
      }
      .blog-post {
        background-color: #000000; /* 改為黑色背景 */
        border-radius: 8px;
        display: inline-block;
        margin-bottom: 20px;
        width: 100%;
        break-inside: avoid; /* 避免文章塊被拆分 */
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-decoration: none;
        transition: none; /* 移除過渡效果 */
      }
      .blog-image img {
        width: 100%;
        height: auto;
        display: block;
        border-bottom: 4px solid #ff0000; /* 圖片下方邊框改為鮮紅色 */
      }
      .blog-content {
        padding: 20px;
        font-family: "Exo", sans-serif;
      }
      /* 標題、日期和分類樣式 */
      .post-date {
        font-size: 10px;
        font-weight: 600;
        color: #ff0000; /* 日期文字顏色改為鮮紅色 */
        margin-bottom: 5px;
        font-family: "Exo", sans-serif;
      }
      .blog-content h2 {
        font-size: 20px;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 5px;
        line-height: 1.2;
      }
      .blog-content p {
        font-size: 14px;
        font-weight: 300;
        color: #a0aec0;
        margin-bottom: 5px;
        line-height: 1.4;
      }
      .category-label {
        display: inline-block;
        background-color: #ff0000; /* 分類標籤改為鮮紅色 */
        color: #000000; /* 標籤文字顏色為黑色 */
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 600;
        margin-top: 10px;
      }
      /* 分頁按鈕樣式 */
      #pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }
      #pagination button {
        background-color: #000000; /* 分頁按鈕背景改為黑色 */
        color: #ffffff;
        border: 1px solid #ff0000; /* 邊框改為鮮紅色 */
        padding: 10px 15px;
        margin: 0 5px;
        cursor: pointer;
        font-family: "Exo", sans-serif;
        transition: none;
      }
      #pagination button.active,
      #pagination button:hover {
        background-color: #ff0000; /* 活動或懸停狀態的按鈕背景改為鮮紅色 */
        color: #000000; /* 活動或懸停狀態的文字顏色改為黑色 */
      }
      #pagination button:disabled {
        background-color: #a0aec0;
        cursor: not-allowed;
      }
      /* 分類按鈕樣式，靠左對齊 */
      #category-buttons {
        display: flex;
        justify-content: flex-start; /* 改為靠左對齊 */
        margin-bottom: 20px; /* 與文章內容的間距 */
        flex-wrap: wrap; /* 如果按鈕太多，讓它們換行 */
      }
      #category-buttons button {
        background-color: #000000; /* 分類按鈕背景改為黑色 */
        color: #ffffff;
        border: 1px solid #ff0000; /* 邊框改為鮮紅色 */
        padding: 10px 15px;
        margin: 5px; /* 確保按鈕之間有間距 */
        cursor: pointer;
        font-family: "Exo", sans-serif;
        border-radius: 100px; /* 圓角設為100px */
        transition: none;
        font-size: 14px;
      }
      #category-buttons button.active,
      #category-buttons button:hover {
        background-color: #ff0000; /* 活動或懸停狀態的按鈕背景改為鮮紅色 */
        color: #000000; /* 活動或懸停狀態的文字顏色改為黑色 */
      }
      #category-buttons button:disabled {
        background-color: #a0aec0;
        cursor: not-allowed;
      }
      /* 手機版樣式 */
      @media (max-width: 768px) {
        #blog-posts {
          column-count: 1; /* 手機版每行顯示一個文章 */
          column-gap: 0; /* 移除列間距 */
        }
        .blog-post {
          width: 100%;
          margin-bottom: 20px;
        }
        .post-date {
          font-size: 12px;
        }
        .blog-content h2 {
          font-size: 18px; /* 手機版標題字體稍微縮小 */
        }
        .blog-content p {
          font-size: 14px; /* 手機版字體稍微縮小 */
        }
        #category-buttons {
          justify-content: center; /* 手機版按鈕居中對齊 */
        }
        #category-buttons button {
          flex: 1 1 auto; /* 讓按鈕根據屏幕寬度調整大小 */
          padding: 10px 5px; /* 調整手機版按鈕內邊距 */
        }
      }
    </style>
  </head>
  <body>
    <script>
      const apiUrl =
        "https://318win.blog/wp-json/wp/v2/posts?_embed&per_page=100"; // 每頁最多抓取 100 篇文章
      let currentPage = 1;
      const postsPerPage = 10;
      let allPosts = []; // 存儲所有文章
      let selectedCategory = ""; // 當前選擇的分類
      // 加載所有頁面的文章，直到抓取完畢
      async function fetchAllPosts(page = 1, shouldScroll = false) {
        let fetchedAllPosts = false;
        let tempPosts = []; // 臨時存儲抓取的文章
        try {
          while (!fetchedAllPosts) {
            const response = await fetch(`${apiUrl}&page=${page}`); // 按頁面逐次抓取
            if (!response.ok) throw new Error("Error fetching posts");
            const data = await response.json();
            tempPosts = tempPosts.concat(data); // 合併新抓取的文章
            // 如果抓取的文章數量小於每頁的最大值，代表已經抓取完所有文章
            if (data.length < 100) {
              fetchedAllPosts = true;
            } else {
              page++; // 繼續抓取下一頁
            }
          }
          // 只保留分類為 "Slot games" 和 "318Promo" 的文章
          allPosts = tempPosts.filter((post) => {
            return post._embedded["wp:term"][0].some((cat) =>
              ["Slot games", "318Promo"].includes(cat.name)
            );
          });
          // 隨機排列文章
          allPosts = allPosts.sort(() => 0.5 - Math.random());
          displayPosts(currentPage); // 顯示當前頁面的文章
          renderPagination(); // 顯示分頁按鈕
          if (shouldScroll) scrollToFirstPost(); // 滾動到文章頂部
        } catch (error) {
          console.error("Error fetching WordPress posts:", error);
        }
      }
      // 顯示分類按鈕
      function displayCategoryButtons() {
        const categories = ["Slot games", "318Promo"];
        let buttonsHTML = "";
        categories.forEach((category) => {
          buttonsHTML += `<button class="${
            category === selectedCategory ? "active" : ""
          }" onclick="filterByCategory('${category}')">${category}</button>`;
        });
        document.getElementById("category-buttons").innerHTML = buttonsHTML;
      }
      // 根據分類過濾文章
      function filterByCategory(category) {
        selectedCategory = category;
        currentPage = 1; // 切換分類時重設頁數
        displayPosts(currentPage); // 只顯示當前頁的文章
        renderPagination(); // 更新分頁
      }
      // 從文章內容中提取第一個圖片 URL
      function extractFirstImage(content) {
        const imgTagMatch = content.match(/<img[^>]+src="?([^"\s]+)"?[^>]*>/);
        return imgTagMatch
          ? imgTagMatch[1]
          : "https://via.placeholder.com/350x150";
      }
      // 顯示當前頁面的文章
      function displayPosts(page) {
        const start = (page - 1) * postsPerPage;
        let selectedPosts = allPosts.slice(start, start + postsPerPage);
        // 如果選擇了分類，根據分類過濾文章
        if (selectedCategory) {
          selectedPosts = selectedPosts.filter((post) => {
            return post._embedded["wp:term"][0].some(
              (cat) => cat.name === selectedCategory
            );
          });
        }
        let postsHTML = "";
        selectedPosts.forEach((post) => {
          const featuredImage =
            post._embedded && post._embedded["wp:featuredmedia"]
              ? post._embedded["wp:featuredmedia"][0].source_url
              : extractFirstImage(post.content.rendered); // 提取文章中的第一個圖片
          const postDate = new Date(post.date).toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          const categories =
            post._embedded["wp:term"] && post._embedded["wp:term"][0]
              ? post._embedded["wp:term"][0].map((cat) => cat.name).join(", ")
              : "Uncategorized";
          postsHTML += `
    <div class="blog-post" onclick="redirectToPost(${post.id})">
      <div class="blog-image">
        <img src="${featuredImage}" alt="${post.title.rendered}">
      </div>
      <div class="blog-content">
        <div class="post-date">${postDate}</div>
        <h2>${post.title.rendered}</h2>
        <p>${post.excerpt.rendered}</p>
        <div class="category-label">${categories}</div>
      </div>
    </div>
  `;
        });
        document.getElementById("blog-posts").innerHTML = postsHTML;
      }
      // 顯示分頁按鈕
      function renderPagination() {
        const totalPages = Math.ceil(allPosts.length / postsPerPage);
        let paginationHTML = "";
        if (currentPage > 1) {
          paginationHTML += `<button onclick="changePage(${
            currentPage - 1
          })">Previous</button>`;
        }
        for (let i = 1; i <= totalPages; i++) {
          paginationHTML += `<button class="${
            i === currentPage ? "active" : ""
          }" onclick="changePage(${i})">${i}</button>`;
        }
        if (currentPage < totalPages) {
          paginationHTML += `<button onclick="changePage(${
            currentPage + 1
          })">Next</button>`;
        }
        document.getElementById("pagination").innerHTML = paginationHTML;
      }
      // 切換頁面
      function changePage(page) {
        currentPage = page;
        displayPosts(currentPage); // 只顯示當前頁的文章
        renderPagination(); // 更新分頁
      }
      // 跳轉到文章詳細頁面
      function redirectToPost(postId) {
        window.location.href = `/posts?post_id=${postId}`;
      }
      // 滾動到第一篇文章
      function scrollToFirstPost() {
        const blogPosts = document.getElementById("blog-posts");
        if (blogPosts) {
          blogPosts.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      }
      // 初始化
      document.addEventListener("DOMContentLoaded", function () {
        displayCategoryButtons(); // 顯示分類按鈕
        console.log("currentPage", currentPage);
        fetchAllPosts(currentPage, false); // 每次載入時抓取並顯示文章
      });
    </script>
  </body>
</html>
